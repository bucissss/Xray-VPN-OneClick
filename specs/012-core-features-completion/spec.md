# Feature Specification: 核心功能完善

**Feature Branch**: `012-core-features-completion`
**Created**: 2026-01-15
**Status**: Draft
**Input**: 功能缺失分析 - 公网IP获取、配置管理菜单、日志查看菜单、用户元数据持久化、配额强制执行集成、日志管理功能

## Clarifications

### Session 2026-01-15

- Q: 公网 IP 检测失败时的回退策略 → A: 超时 3 秒，重试 1 次后失败则提示手动输入

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 获取可用的分享链接 (Priority: P1)

作为 VPN 服务管理员，我希望当生成用户分享链接时，系统能自动获取服务器的公网 IP 地址，这样用户可以直接使用分享链接连接，而不需要手动替换服务器地址。

**Why this priority**: 这是最关键的功能缺失。当前分享链接显示 "your-server-ip"，使得链接完全无法使用，用户体验严重受损。

**Independent Test**: 可以通过生成分享链接并验证链接中包含有效的公网 IP 地址来独立测试。

**Acceptance Scenarios**:

1. **Given** 服务器部署在公网环境, **When** 管理员为用户生成分享链接, **Then** 链接中包含服务器的实际公网 IP 地址
2. **Given** 服务器处于 NAT 环境（私有 IP）, **When** 管理员首次生成分享链接, **Then** 系统提示管理员输入公网 IP 并记住该配置
3. **Given** 无法获取公网 IP（网络问题）, **When** 管理员生成分享链接, **Then** 系统显示友好的错误信息并提供手动输入选项

---

### User Story 2 - 实时查看系统日志 (Priority: P2)

作为 VPN 服务管理员，我希望能够在交互式菜单中查看 Xray 服务的访问日志和错误日志，以便快速诊断连接问题和监控服务状态。

**Why this priority**: 日志查看是故障排查的核心功能，目前菜单显示"功能即将推出"，用户需要使用其他工具查看日志。

**Independent Test**: 可以通过进入日志查看菜单，选择日志类型，验证日志内容正确显示来独立测试。

**Acceptance Scenarios**:

1. **Given** Xray 服务正在运行, **When** 管理员选择"查看日志", **Then** 显示最近的访问日志条目
2. **Given** 管理员正在查看日志, **When** 管理员选择"错误日志", **Then** 仅显示错误级别的日志
3. **Given** 日志内容较多, **When** 管理员查看日志, **Then** 支持分页浏览或限制显示行数
4. **Given** 日志文件不存在或为空, **When** 管理员查看日志, **Then** 显示友好的提示信息

---

### User Story 3 - 管理服务配置 (Priority: P2)

作为 VPN 服务管理员，我希望能够通过交互式菜单管理 Xray 配置，包括查看当前配置、备份和恢复配置，以便安全地进行配置更改。

**Why this priority**: 配置管理对于维护服务稳定性至关重要，目前菜单显示"功能即将推出"。

**Independent Test**: 可以通过进入配置管理菜单，执行备份操作，验证备份文件生成来独立测试。

**Acceptance Scenarios**:

1. **Given** 管理员进入配置管理菜单, **When** 选择"查看当前配置", **Then** 以格式化方式显示当前 Xray 配置
2. **Given** 管理员选择"备份配置", **When** 确认备份, **Then** 创建带时间戳的配置备份文件
3. **Given** 存在备份文件, **When** 管理员选择"恢复配置", **Then** 显示可用备份列表供选择
4. **Given** 管理员选择恢复某个备份, **When** 确认恢复, **Then** 恢复配置并自动重启服务

---

### User Story 4 - 用户状态持久化 (Priority: P3)

作为 VPN 服务管理员，我希望用户的创建时间和状态能够被正确保存和显示，以便追踪用户历史和管理用户生命周期。

**Why this priority**: 当前用户创建时间每次都重新生成，用户状态固定为 active，这使得用户管理信息不准确。

**Independent Test**: 可以通过创建用户、重启应用、再次查看用户列表，验证创建时间保持不变来独立测试。

**Acceptance Scenarios**:

1. **Given** 管理员创建新用户, **When** 用户成功创建, **Then** 用户的创建时间被记录并持久保存
2. **Given** 用户已存在于系统中, **When** 管理员查看用户列表, **Then** 显示用户的实际创建时间
3. **Given** 用户配额已超限, **When** 查看用户列表, **Then** 用户状态显示为"超限"而非"活跃"

---

### User Story 5 - 配额自动执行 (Priority: P3)

作为 VPN 服务管理员，我希望系统能够自动检查用户配额并禁用超限用户，而不需要手动监控每个用户的流量使用情况。

**Why this priority**: QuotaEnforcer 服务已实现但未集成到主菜单，管理员无法方便地执行配额检查。

**Independent Test**: 可以通过在配额管理菜单中执行"检查配额"操作，验证超限用户被正确标记来独立测试。

**Acceptance Scenarios**:

1. **Given** 管理员在配额管理菜单, **When** 选择"执行配额检查", **Then** 系统检查所有用户并报告结果
2. **Given** 某用户流量超过配额, **When** 执行配额检查, **Then** 该用户被标记为超限状态
3. **Given** 配额检查完成, **When** 有用户状态变更, **Then** 显示变更摘要（正常/警告/超限用户数量）

---

### Edge Cases

- **网络问题**: 当无法访问外部 IP 检测服务时，应提供手动输入选项并缓存结果
- **日志文件过大**: 应限制读取的日志行数，避免内存问题
- **并发配置修改**: 恢复配置时应检查配置是否有未保存的更改
- **Stats API 未启用**: 流量统计不可用时应显示友好提示而非错误
- **权限问题**: 读写配置文件或日志需要适当权限，应提供清晰的错误信息

## Requirements *(mandatory)*

### Functional Requirements

**公网 IP 获取**
- **FR-001**: 系统 MUST 能够自动检测服务器的公网 IP 地址（超时 3 秒，失败后重试 1 次）
- **FR-002**: 系统 MUST 在 NAT 环境下或检测失败后提供手动输入公网 IP 的选项
- **FR-003**: 系统 MUST 缓存已配置的公网 IP，避免重复获取
- **FR-004**: 系统 MUST 在分享链接中使用实际的公网 IP 地址

**日志查看**
- **FR-005**: 系统 MUST 支持查看 Xray 访问日志
- **FR-006**: 系统 MUST 支持查看 Xray 错误日志
- **FR-007**: 系统 MUST 限制单次显示的日志行数（默认 50 行）
- **FR-008**: 系统 MUST 在日志文件不存在时显示友好提示

**配置管理**
- **FR-009**: 系统 MUST 支持查看当前 Xray 配置
- **FR-010**: 系统 MUST 支持创建配置备份（带时间戳）
- **FR-011**: 系统 MUST 支持从备份恢复配置
- **FR-012**: 系统 MUST 在恢复配置后自动重启服务

**用户元数据**
- **FR-013**: 系统 MUST 持久化用户创建时间
- **FR-014**: 系统 MUST 从持久化存储读取用户状态
- **FR-015**: 系统 MUST 在用户列表中显示准确的创建时间和状态

**配额执行**
- **FR-016**: 系统 MUST 在配额管理菜单提供"执行配额检查"选项
- **FR-017**: 系统 MUST 显示配额检查的执行结果摘要
- **FR-018**: 系统 MUST 自动更新超限用户的状态

### Key Entities

- **ServerConfig**: 服务器配置信息，包含公网 IP、端口等网络设置
- **UserMetadata**: 用户元数据，包含创建时间、状态变更历史
- **LogEntry**: 日志条目，包含时间戳、级别、内容
- **ConfigBackup**: 配置备份，包含备份时间、文件路径、备注

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 生成的分享链接包含有效的服务器地址，用户可直接使用链接连接（100% 可用性）
- **SC-002**: 管理员可在 5 秒内从主菜单进入日志查看界面
- **SC-003**: 配置备份和恢复操作在 10 秒内完成
- **SC-004**: 用户创建时间在应用重启后保持准确（误差小于 1 秒）
- **SC-005**: 配额检查可在 3 秒内完成对 100 个用户的状态更新
- **SC-006**: 所有新功能集成后，主菜单中不再显示"功能即将推出"提示

## Assumptions

- 系统运行在支持外网访问的环境中，或管理员知道服务器的公网 IP
- Xray 日志文件位于标准路径 `/var/log/xray/`
- 配置备份存储在 `/var/backups/xray/` 目录
- Stats API 已正确配置用于流量统计
- 系统具有读写日志文件和配置文件的权限

## Scope Boundaries

**包含**:
- 公网 IP 自动检测和缓存
- 日志查看菜单功能
- 配置管理菜单功能
- 用户元数据持久化
- 配额执行菜单集成

**不包含**:
- Reality 协议密钥生成（可作为后续功能）
- 日志搜索和高级过滤（本期仅实现基础查看）
- 配置编辑（本期仅实现查看和备份恢复）
- 定时配额检查任务（本期仅实现手动触发）

## Dependencies

- 现有的 `log-manager.ts` 服务
- 现有的 `config-manager.ts` 服务
- 现有的 `quota-enforcer.ts` 服务
- 外部 IP 检测服务（如 ifconfig.me、ip.sb 等）
