# Feature Specification: Xray 服务管理 CLI 工具

**Feature Branch**: `001-npm-cli-tool`
**Created**: 2026-01-07
**Status**: Draft
**Input**: User description: "readme里面提到的服务管理能不能用做成npm下载之后就能在命令行界面交互的形式？"

## Clarifications

### Session 2026-01-07

- Q: 删除用户后是否需要重启 Xray 服务？ → A: 总是重启服务，确保删除的用户立即失效（安全性优先）
- Q: 添加新用户后是否需要重启 Xray 服务？ → A: 总是重启服务，确保新用户立即可用（与删除操作保持一致性）
- Q: 敏感信息（Private Key、UUID）的显示方式？ → A: 默认脱敏显示（如显示前4位和后4位），提供按键复制完整内容到剪贴板的功能
- Q: 修改配置项后是否需要重启 Xray 服务？ → A: 自动重启服务，使配置立即生效（与用户管理操作保持一致性）
- Q: 服务重启过程中的连接处理策略？ → A: 采用优雅关闭策略（graceful shutdown，等待现有连接完成或超时后重启），显示预计中断时间提示

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 安装和启动交互式管理工具 (Priority: P1)

系统管理员通过 npm 全局安装 Xray 管理工具后，在任何目录下运行单一命令即可启动交互式菜单，无需记忆复杂的脚本路径和参数。

**Why this priority**: 这是最核心的功能，提供了从 Bash 脚本到现代 CLI 工具的转变基础。没有这个功能，其他交互式功能都无法使用。

**Independent Test**: 可以通过执行 `npm install -g xray-manager` 安装工具，然后运行 `xray-manager` 或 `xm` 启动交互式菜单来完整测试此功能，验证菜单是否正确显示并能接受用户输入。

**Acceptance Scenarios**:

1. **Given** 用户已安装 Node.js (v14+), **When** 用户执行 `npm install -g xray-manager`, **Then** 工具成功安装并可通过 `xray-manager` 或简写 `xm` 命令全局调用
2. **Given** 工具已安装, **When** 用户在终端执行 `xray-manager` 或 `xm`, **Then** 显示交互式主菜单，列出所有可用操作（查看状态、启动/停止服务、用户管理、配置管理等）
3. **Given** 交互式菜单已显示, **When** 用户使用上下方向键选择菜单项并按回车, **Then** 系统执行对应操作或进入子菜单
4. **Given** 用户在任何菜单界面, **When** 用户按 Ctrl+C 或选择"退出"选项, **Then** 优雅退出程序并显示友好告别消息

---

### User Story 2 - 交互式服务状态查看和控制 (Priority: P1)

系统管理员通过交互式菜单查看 Xray 服务实时状态（运行中/已停止、运行时长、内存占用等），并能通过简单选择完成启动、停止、重启服务操作。

**Why this priority**: 服务状态查看和控制是最常用的管理操作，与 P1 用户故事 1 同等重要，构成 MVP 的核心功能。

**Independent Test**: 可以通过启动工具后选择"查看服务状态"菜单项来独立测试，验证是否正确显示服务状态；选择"启动/停止/重启服务"菜单项验证服务控制功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 用户在主菜单, **When** 选择"查看服务状态", **Then** 实时显示 Xray 服务状态（运行中/已停止）、运行时长、端口占用、最近日志条目
2. **Given** 服务当前已停止, **When** 用户选择"启动服务", **Then** 系统执行启动命令，显示启动进度，成功后显示确认消息和服务地址信息
3. **Given** 服务当前正在运行, **When** 用户选择"停止服务", **Then** 系统提示确认操作，确认后停止服务并显示成功消息
4. **Given** 服务当前正在运行, **When** 用户选择"重启服务", **Then** 系统采用优雅关闭策略（等待现有连接完成或超时）先停止后启动服务，全程显示进度反馈和预计中断时间
5. **Given** 操作执行失败（如权限不足）, **When** 错误发生, **Then** 显示中英文双语错误提示和建议解决方案（如"请使用 sudo 运行"）

---

### User Story 3 - 交互式用户管理 (Priority: P2)

系统管理员通过交互式菜单查看当前所有 Xray 用户列表、添加新用户（自动生成 UUID 和配置）、删除用户、查看用户的连接分享链接和二维码。

**Why this priority**: 用户管理是仅次于服务控制的常用功能，但不属于 MVP 的绝对必需功能。管理员可以暂时使用原有 Bash 脚本完成用户管理。

**Independent Test**: 可以通过选择"用户管理"菜单进入用户管理子菜单，独立测试添加用户、列出用户、删除用户、显示分享链接等功能。

**Acceptance Scenarios**:

1. **Given** 用户在主菜单, **When** 选择"用户管理", **Then** 进入用户管理子菜单，显示可用操作（列出用户、添加用户、删除用户、查看分享链接）
2. **Given** 用户在用户管理菜单选择"列出所有用户", **When** 系统执行查询, **Then** 以表格形式显示所有用户的邮箱/标识、UUID、创建时间、状态（活跃/禁用）
3. **Given** 用户选择"添加新用户", **When** 用户输入邮箱或标识符, **Then** 系统自动生成 UUID，更新配置文件，自动重启 Xray 服务使新用户立即可用，显示新用户信息和分享链接
4. **Given** 用户选择"删除用户", **When** 用户从列表中选择要删除的用户并确认, **Then** 系统从配置中移除该用户，自动重启 Xray 服务使删除立即生效，显示成功消息
5. **Given** 用户选择"查看分享链接", **When** 用户从列表中选择用户, **Then** 显示该用户的 VLESS 分享链接、二维码（ASCII 艺术或提示使用 qrencode）、客户端配置参数（敏感信息如 UUID 和密钥默认脱敏显示，提供按键复制完整内容功能）

---

### User Story 4 - 交互式配置管理 (Priority: P3)

系统管理员通过交互式菜单查看当前配置、备份配置、从备份恢复配置、修改常用配置项（如端口、伪装域名等）。

**Why this priority**: 配置管理是高级功能，大多数用户在初始安装后很少修改配置。此功能可以在后续版本添加。

**Independent Test**: 可以通过选择"配置管理"菜单进入配置管理子菜单，独立测试查看配置、备份、恢复、修改等功能。

**Acceptance Scenarios**:

1. **Given** 用户在主菜单选择"配置管理", **When** 进入配置管理子菜单, **Then** 显示可用操作（查看配置、备份配置、恢复配置、修改配置）
2. **Given** 用户选择"查看当前配置", **When** 系统读取配置文件, **Then** 以易读格式显示关键配置项（端口、协议、伪装域名等），敏感信息（Private Key、UUID）默认脱敏显示（显示前4位和后4位），提供按键复制完整内容功能
3. **Given** 用户选择"备份配置", **When** 系统执行备份, **Then** 创建带时间戳的配置备份文件到 `/var/backups/xray/`，显示备份文件路径
4. **Given** 用户选择"恢复配置"且存在备份, **When** 用户从备份列表中选择要恢复的备份并确认, **Then** 系统先备份当前配置，然后恢复选定备份，自动重启 Xray 服务使配置生效，显示成功消息
5. **Given** 用户选择"修改配置项", **When** 用户选择要修改的配置项（如端口）并输入新值, **Then** 系统验证输入合法性，更新配置文件，自动重启 Xray 服务使配置立即生效，显示成功消息

---

### User Story 5 - 交互式日志查看 (Priority: P3)

系统管理员通过交互式菜单实时查看 Xray 服务日志、按时间范围过滤日志、按级别过滤日志（错误/警告/信息）。

**Why this priority**: 日志查看是故障排查的重要工具，但管理员也可以直接使用 `journalctl` 命令查看日志，因此优先级较低。

**Independent Test**: 可以通过选择"查看日志"菜单进入日志查看界面，独立测试实时日志查看、历史日志查看、日志过滤等功能。

**Acceptance Scenarios**:

1. **Given** 用户在主菜单选择"查看日志", **When** 进入日志查看菜单, **Then** 显示日志查看选项（实时日志、最近 100 条、最近 24 小时、按级别过滤）
2. **Given** 用户选择"实时日志", **When** 系统开始流式显示日志, **Then** 实时显示 Xray 服务新产生的日志条目，并支持按 Ctrl+C 停止查看返回菜单
3. **Given** 用户选择"最近 N 条日志", **When** 用户输入条数（默认 100）, **Then** 显示最近 N 条日志，按时间倒序排列，并高亮显示错误和警告
4. **Given** 用户选择"按级别过滤", **When** 用户选择日志级别（错误/警告/信息）, **Then** 仅显示该级别的日志条目

---

### Edge Cases

- **工具以非 root 权限运行**: 许多操作（启动/停止服务、修改配置）需要 root 权限。工具应检测权限不足并提示用户使用 `sudo` 重新运行。
- **Xray 服务未安装**: 如果系统未安装 Xray 或配置文件不存在，工具应友好提示用户先运行安装脚本，并提供安装指引链接。
- **并发操作冲突**: 如果多个管理员同时使用工具修改配置，可能导致配置冲突。建议在配置修改前检查文件修改时间，发现冲突时警告用户。
- **网络问题导致 npm 安装失败**: 提供国内镜像源安装方式（如使用淘宝 npm 镜像），并在文档中说明。
- **不同 Linux 发行版的兼容性**: 工具应检测操作系统类型（Debian/Ubuntu/CentOS/Kali），对不同系统的 systemd 命令、路径差异进行适配。
- **配置文件格式错误**: 如果配置文件 JSON 格式损坏，工具应捕获解析错误并提示用户从备份恢复或手动修复。
- **用户输入非法字符**: 在用户输入邮箱、端口号等信息时，必须验证输入格式，防止注入攻击或配置错误。
- **服务重启时的活跃连接**: 重启服务会中断现有 VPN 连接。采用优雅关闭策略（10秒超时），若超时仍有连接则强制停止。用户应在重启前通知客户端用户可能的短暂中断（预计 5-10 秒）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 工具必须通过 npm 全局安装，安装后可通过 `xray-manager` 或简写 `xm` 命令在任何目录下调用
- **FR-002**: 工具必须提供交互式主菜单，列出所有可用的管理操作分类（服务管理、用户管理、配置管理、日志查看）
- **FR-003**: 用户必须能够通过上下方向键或数字键选择菜单项，按回车键确认执行
- **FR-004**: 工具必须支持查看 Xray 服务状态（运行/停止、运行时长、端口、进程 ID）
- **FR-005**: 工具必须支持服务控制操作（启动、停止、重启服务），并在操作前后提供清晰的状态反馈
- **FR-006**: 工具必须支持用户管理功能：列出所有用户、添加新用户（自动生成 UUID 并重启服务使其立即可用）、删除用户（删除后自动重启服务确保立即失效）、查看用户分享链接
- **FR-007**: 工具必须支持配置管理功能：查看配置、备份配置、恢复配置（恢复后自动重启服务）、修改常用配置项（端口、伪装域名，修改后自动重启服务使配置生效）
- **FR-008**: 工具必须支持日志查看功能：实时日志、历史日志（按条数或时间范围）、按级别过滤
- **FR-009**: 所有操作必须检测执行权限，权限不足时提示用户使用 `sudo` 运行
- **FR-010**: 工具必须在未检测到 Xray 安装时，提示用户先安装并提供文档链接
- **FR-011**: 所有用户输入必须经过验证（邮箱格式、端口号范围、域名格式等），防止非法输入
- **FR-012**: 配置文件修改前必须自动创建备份到 `/var/backups/xray/` 目录
- **FR-013**: 工具必须支持中英文双语界面，根据系统语言环境自动切换（默认中文，英文作为备选）
- **FR-014**: 所有错误必须提供清晰的错误消息和建议解决方案（例如："端口 443 被占用，建议使用 `lsof -i :443` 查看占用进程"）
- **FR-015**: 工具必须提供 `--help` 参数显示使用帮助，`--version` 参数显示版本号
- **FR-016**: 所有需要重启服务的操作（用户管理、配置修改/恢复）必须采用优雅关闭策略（graceful shutdown），等待现有连接完成或超时（建议超时时间 10 秒）后再重启，并向用户显示预计中断时间和重启进度

### Constitution Compliance Requirements

根据项目宪章 (`.specify/memory/constitution.md`)，以下要求是强制性的：

- **CR-001**: 安全性 - 所有密钥/UUID 必须自动生成；敏感信息（Private Key、UUID）在显示时必须默认脱敏（显示前4位和后4位，中间用省略号或星号代替），并提供按键快捷方式复制完整内容到剪贴板，避免屏幕泄露
- **CR-002**: 简洁性 - 交互式菜单必须直观易用，提供中英文双语提示，80% 的常用操作不超过 3 层菜单深度
- **CR-003**: 可靠性 - 所有配置修改操作前必须自动备份，支持一键恢复；工具必须兼容 Debian/Ubuntu/CentOS/Kali 等主流发行版
- **CR-004**: 测试 - 核心功能（服务控制、用户管理、配置备份恢复）必须先编写集成测试用例，遵循红-绿-重构流程
- **CR-005**: 文档 - 必须更新 README.md 添加 npm 安装和使用说明，替换原有 Bash 脚本使用说明；提供 CLI 工具的完整命令文档

### Key Entities

- **CLI 工具**: npm 包，提供全局命令 `xray-manager` 和简写 `xm`，封装所有 Xray 服务管理功能
- **交互式菜单**: 基于用户输入的多层级菜单系统，提供直观的操作选择界面
- **服务管理器**: 负责与 systemd 交互，执行服务启动、停止、重启、状态查询操作
- **用户配置**: 存储在 Xray 配置文件中的用户列表，包含 UUID、邮箱/标识符、创建时间等信息
- **配置备份**: 存储在 `/var/backups/xray/` 目录下的带时间戳的配置文件副本
- **日志查看器**: 通过 `journalctl` 或日志文件读取 Xray 服务日志，支持过滤和实时查看

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在 3 分钟内完成工具安装（npm install）并成功启动交互式菜单
- **SC-002**: 90% 的常用操作（查看状态、启动/停止服务、添加用户）可以在 5 次按键内完成（不超过 3 层菜单深度）
- **SC-003**: 用户从选择操作到看到执行结果的响应时间不超过 2 秒（不包括服务启动等耗时操作本身）
- **SC-004**: 所有错误场景（权限不足、服务未安装、配置文件损坏等）都提供清晰的中英文错误提示和解决建议
- **SC-005**: 工具在主流 Linux 发行版（Debian 10+, Ubuntu 20.04+, CentOS 8+, Kali Linux）上安装和运行成功率达到 95%
- **SC-006**: 配置文件损坏或误操作后，用户可以在 1 分钟内从备份恢复到正常状态
- **SC-007**: 用户反馈调查显示，使用 CLI 工具相比原有 Bash 脚本，操作便捷性提升 60% 以上
- **SC-008**: 减少 GitHub Issues 中关于"如何使用管理脚本"的问题数量 50%

## Assumptions

1. **Node.js 环境**: 假设目标用户能够安装 Node.js v14 或更高版本（这是合理的，因为 Node.js 已成为服务器端常用工具）
2. **网络访问**: 假设用户可以访问 npm 官方仓库或国内镜像（淘宝镜像），能够下载 npm 包
3. **systemd 环境**: 假设目标系统使用 systemd 作为服务管理器（覆盖主流现代 Linux 发行版）
4. **配置文件路径**: 假设 Xray 配置文件位于 `/usr/local/etc/xray/config.json`（与当前 Bash 脚本保持一致）
5. **备份目录权限**: 假设 `/var/backups/xray/` 目录可由 root 用户创建和写入
6. **终端环境**: 假设用户使用支持 ANSI 转义序列的现代终端（用于颜色、光标控制等）
7. **包名可用性**: 假设 `xray-manager` 或类似名称在 npm 仓库中可用（需要在开发前检查并注册）

## Out of Scope

以下功能不在本次功能范围内，可作为未来增强考虑：

- **图形化界面**: 本功能专注于命令行交互式界面，不包含 Web UI 或桌面 GUI
- **远程管理**: 不支持通过网络远程管理其他服务器上的 Xray 服务（仅管理本地服务）
- **多服务器支持**: 不支持同时管理多台服务器的 Xray 服务
- **自动更新 Xray 核心**: 工具本身不负责升级 Xray-core，用户仍需使用原有更新脚本
- **流量统计和监控**: 不包含流量统计、用户带宽监控等高级功能
- **配置可视化编辑**: 不提供完整的 JSON 配置可视化编辑器，仅支持修改常用配置项
- **客户端配置生成**: 不自动生成客户端配置文件（如 v2rayN 配置），仅提供分享链接和二维码
