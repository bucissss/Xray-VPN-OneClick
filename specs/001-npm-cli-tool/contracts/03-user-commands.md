# Contract: 用户管理命令

**命令**: `xray-manager user <subcommand>`
**别名**: `xm user <subcommand>`
**用户故事**: [US3 - 交互式用户管理](../spec.md#user-story-3---交互式用户管理-priority-p2)

---

## Subcommands

| 子命令 | 描述 | 权限要求 | 自动重启服务 |
|--------|------|----------|-------------|
| `list` | 列出所有用户 | 普通用户 | 否 |
| `add <email>` | 添加新用户 | root | **是**（符合规范澄清） |
| `delete <email>` | 删除用户 | root | **是**（符合规范澄清） |
| `show <email>` | 显示分享链接 | 普通用户 | 否 |

---

## 1. user list

### Usage
```bash
xray-manager user list [options]
xm user list
```

### Output (标准格式 - 符合 FR-006)
```
╔═══════════════════════════════════════════════════════════╗
║                    用户列表                               ║
╚═══════════════════════════════════════════════════════════╝

总计: 3 个用户

┌─────┬────────────────────┬─────────────────┬────────────────────┬────────┐
│ #   │ 邮箱/标识符        │ UUID (前4后4)   │ 创建时间           │ 状态   │
├─────┼────────────────────┼─────────────────┼────────────────────┼────────┤
│ 1   │ user1@example.com  │ 1234...abcd     │ 2026-01-05 10:30   │ ✅活跃 │
│ 2   │ user2@example.com  │ 5678...efgh     │ 2026-01-06 14:20   │ ✅活跃 │
│ 3   │ user3@example.com  │ 9012...ijkl     │ 2026-01-07 09:15   │ ✅活跃 │
└─────┴────────────────────┴─────────────────┴────────────────────┴────────┘

提示: 使用 'xray-manager user show <email>' 查看详细信息和分享链接
```

### Output (JSON格式)
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "12345678-1234-4567-8901-abcdefabcdef",
        "email": "user1@example.com",
        "createdAt": "2026-01-05T10:30:00.000Z",
        "status": "active",
        "level": 0,
        "flow": "xtls-rprx-vision"
      }
    ],
    "total": 3
  },
  "timestamp": "2026-01-07T10:30:45.123Z"
}
```

---

## 2. user add (关键操作 - 自动重启服务)

### Usage
```bash
xray-manager user add <email> [options]
xm user add user@example.com --flow xtls-rprx-vision
```

### Parameters
| 参数 | 类型 | 描述 | 默认值 |
|------|------|------|--------|
| `<email>` | string | 用户邮箱/标识符（必需） | - |
| `--flow <type>` | string | 流控模式 | `xtls-rprx-vision` |
| `--level <n>` | number | 协议级别 | `0` |
| `--no-restart` | boolean | 不自动重启服务 | `false` |
| `--json` | boolean | JSON 格式输出 | `false` |

### Output (标准格式 - 符合 FR-006 和规范澄清)
```
➕ 添加新用户: user@example.com

✅ UUID 生成成功: 1234abcd-5678-4ef0-9abc-defghijklmno
⏳ 正在更新配置文件...
✅ 配置已更新

⚠️  新用户需要重启服务才能生效（规范澄清：总是重启）
🔄 正在重启服务...
⏱️  预计中断时间: 5-10 秒
⏳ 等待活跃连接完成（超时: 10 秒）...
✅ 服务重启成功（中断时间: 6.2 秒）

╔═══════════════════════════════════════════════════════════╗
║                  用户创建成功                             ║
╚═══════════════════════════════════════════════════════════╝

用户信息:
  邮箱:     user@example.com
  UUID:     1234****-****-****-****-********mnop  [按 C 复制完整]
  流控:     xtls-rprx-vision
  级别:     0
  创建时间: 2026-01-07 10:30:45
  状态:     ✅ 活跃

💡 下一步:
   查看分享链接: xray-manager user show user@example.com
```

### Behavior (符合规范澄清)
1. **步骤 1**: 验证邮箱格式
2. **步骤 2**: 生成 UUID v4（使用 `crypto.randomUUID()`）
3. **步骤 3**: 更新配置文件（自动备份原配置）
4. **步骤 4**: **总是重启服务**（确保新用户立即可用，符合规范澄清）
5. **步骤 5**: 验证服务状态

### Exit Codes
- `0`: 成功添加
- `2`: 邮箱格式无效
- `3`: 配置文件错误
- `4`: 权限不足
- `5`: 服务重启失败

---

## 3. user delete (关键操作 - 自动重启服务)

### Usage
```bash
xray-manager user delete <email> [options]
xm user delete user@example.com
```

### Parameters
| 参数 | 类型 | 描述 | 默认值 |
|------|------|------|--------|
| `<email>` | string | 用户邮箱/标识符（必需） | - |
| `--no-confirm` | boolean | 跳过确认提示 | `false` |
| `--no-restart` | boolean | 不自动重启服务 | `false` |
| `--json` | boolean | JSON 格式输出 | `false` |

### Output (标准格式 - 符合规范澄清)
```
➖ 删除用户: user@example.com

⚠️  确定要删除用户 "user@example.com" 吗? (y/N) y

⏳ 正在更新配置文件...
✅ 用户已从配置中移除

⚠️  删除的用户需要重启服务才能立即失效（规范澄清：总是重启）
🔄 正在重启服务...
⏱️  预计中断时间: 5-10 秒
✅ 服务重启成功（中断时间: 5.8 秒）

✅ 用户删除成功

已删除用户:
  邮箱: user@example.com
  UUID: 1234****-****-****-****-********mnop
  删除时间: 2026-01-07 10:35:00

💡 提示: 此用户的分享链接已失效
```

### Behavior (符合规范澄清 - 安全性优先)
1. **步骤 1**: 确认操作（可用 `--no-confirm` 跳过）
2. **步骤 2**: 从配置中移除用户
3. **步骤 3**: 自动备份配置
4. **步骤 4**: **总是重启服务**（确保删除的用户立即失效，符合规范澄清，安全性优先）
5. **步骤 5**: 验证服务状态

---

## 4. user show (脱敏显示 + 复制功能)

### Usage
```bash
xray-manager user show <email> [options]
xm user show user@example.com
```

### Parameters
| 参数 | 类型 | 描述 | 默认值 |
|------|------|------|--------|
| `<email>` | string | 用户邮箱/标识符（必需） | - |
| `--full` | boolean | 显示完整敏感信息（不脱敏） | `false` |
| `--qrcode` | boolean | 显示二维码 | `false` |
| `--json` | boolean | JSON 格式输出 | `false` |

### Output (标准格式 - 符合 CR-001 脱敏要求)
```
╔═══════════════════════════════════════════════════════════╗
║              用户分享信息 - user@example.com              ║
╚═══════════════════════════════════════════════════════════╝

用户基本信息:
  邮箱:     user@example.com
  UUID:     1234****-****-****-****-********mnop  [C: 复制完整]
  流控:     xtls-rprx-vision
  级别:     0
  创建时间: 2026-01-05 10:30:00
  状态:     ✅ 活跃

服务器配置:
  协议:     VLESS
  地址:     vpn.example.com
  端口:     443
  加密:     Reality
  传输:     TCP
  TLS:      是

Reality 配置:
  Public Key: abcd****************************wxyz  [C: 复制完整]
  Short ID:   1234****abcd                         [C: 复制完整]
  Server Name: www.microsoft.com

分享链接:
  VLESS URL:  vless://********************************  [C: 复制完整]

─────────────────────────────────────────────────────────────

? 快捷操作:
  ❯ 📋 复制 UUID
    🔑 复制 Public Key
    🆔 复制 Short ID
    🔗 复制分享链接
    📱 显示二维码
    🔙 返回

[提示: 按 C 键快速复制当前选中项]
```

当用户按 `C` 键或选择"复制 UUID"：
```
✅ UUID 已复制到剪贴板
完整 UUID: 12345678-1234-4567-8901-abcdefabcdef
```

### 脱敏规则（符合 CR-001）
- **UUID**: 显示前 4 位 + 后 4 位，中间用 `****` 代替
- **Public Key**: 显示前 4 位 + 后 4 位
- **Short ID**: 显示前 4 位 + 后 4 位
- **分享链接**: 仅显示协议头 `vless://`，其余用 `****` 代替
- **复制功能**: 提供按键快捷方式复制完整内容到剪贴板

### Output (使用 `--full` 显示完整信息)
```
⚠️  警告: 即将显示完整敏感信息，请确保周围环境安全

确定要显示完整信息吗? (y/N) y

[... 显示完整 UUID、密钥、分享链接 ...]
```

---

## Testing Checklist

### 功能测试
- [ ] list: 正确显示所有用户
- [ ] add: 成功添加用户并自动重启服务
- [ ] add: 邮箱格式验证
- [ ] add: UUID 自动生成（不重复）
- [ ] delete: 成功删除用户并自动重启服务
- [ ] delete: 确认提示正常工作
- [ ] show: 敏感信息默认脱敏显示
- [ ] show: 复制功能正常工作
- [ ] show: `--full` 标志显示完整信息

### 安全测试（符合 CR-001）
- [ ] 敏感信息脱敏：UUID 前4后4
- [ ] 敏感信息脱敏：Public Key 前4后4
- [ ] 敏感信息脱敏：Short ID 前4后4
- [ ] 剪贴板复制：正确复制完整内容
- [ ] `--full` 标志：显示警告并要求确认

### 服务重启测试（符合规范澄清）
- [ ] add: 总是重启服务（确保新用户立即可用）
- [ ] delete: 总是重启服务（确保删除立即生效，安全性优先）
- [ ] 重启采用优雅关闭策略（10秒超时）
- [ ] 显示预计中断时间和实际中断时间

---

## Constitution Compliance

### ✅ I. 安全第一 (CR-001)
- **敏感信息脱敏**: UUID、密钥、分享链接默认脱敏显示（前4后4）
- **剪贴板复制**: 提供按键快捷方式复制完整内容，避免屏幕泄露
- **自动重启服务**: 删除用户后立即重启，确保安全性（用户立即失效）
- **UUID 自动生成**: 使用 `crypto.randomUUID()` 生成，禁止硬编码

### ✅ II. 简洁易用 (CR-002)
- **表格显示**: 用户列表以表格形式清晰展示
- **快捷操作**: 提供 `C` 键快速复制
- **友好提示**: 所有操作提供下一步建议

### ✅ III. 可靠稳定 (CR-003)
- **配置自动备份**: 每次修改前自动备份
- **验证邮箱格式**: 防止无效输入
- **服务状态验证**: 重启后验证服务正常运行

---

**最后更新**: 2026-01-07
**状态**: ✅ 已完成
